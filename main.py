#coding=utf-8
# __author__ = 'shuige'
# Full automatic scanning tool for Pentesters
# 1904521507[at]qq.com (http://github.com/rassec)
import os
import re
import sys
import time
import json
import requests
import argparse
import logging
from string import Template
from report_all import TEMPLATE_html
import subprocess
import webbrowser
import optparse


reload(sys)
sys.setdefaultencoding("utf-8")

subdomain_jiejie=[]
logging.basicConfig(
    level=logging.INFO, # filename='/tmp/wyproxy.log',
    format='[%(levelname)s] %(message)s',
)

'''
del txt files
waring wvs result report
'''
os.system("cls&&del *.txt")
os.system("mkdir d:\wwwscanresult")
print "wvs saved d:\wwwscanresult"
time.sleep(3)



class FlushFile(object):
    """Write-only flushing wrapper for file-type objects."""
    def __init__(self, f):
        self.f = f
    def write(self, x):
        self.f.write(x)
        self.f.flush()

sys.stdout = FlushFile(sys.__stdout__)



def save_result(filename, args):
    try:
        fd = open(filename, 'w')
        json.dump(args, fd, indent=4)
    finally:
        fd.close()

'''
    subdomainbuter interface 1
'''
def sub_doman_jiejie(url_domain):
    popen = subprocess.Popen(['python', 'subDomainsBrute.py', '{name}'.format(name=url_domain),'-t 150'], stdout = subprocess.PIPE)
    while True:
        next_line = popen.stdout.readline()
        if next_line == '' and popen.poll() != None:
            break
        '''sys.stdout.write(next_line)'''
        sys.stdout.write(next_line)
        subdomain_jiejie.append(next_line)
    return list(set(subdomain_jiejie))


'''
 wydomain interface 2
'''
def sub_domain_wydomain(url_domain):
    popen = subprocess.Popen(['python', 'wydomain.py', '-d','{name}'.format(name=url_domain)], stdout = subprocess.PIPE)
    while True:
        next_line = popen.stdout.readline()
        if next_line == '' and popen.poll() != None:
            break
        sys.stdout.write(next_line)

'''
sublistdir interface 3
'''
def sub_domain_sublist(url_domain):
    popen = subprocess.Popen(['python', 'sublist3r.py', '-d','{name}'.format(name=url_domain),'-o {name}_sublistdir.txt'.format(name=url_domain)], stdout = subprocess.PIPE)
    while True:
        next_line = popen.stdout.readline()
        if next_line == '' and popen.poll() != None:
            break
        sys.stdout.write(next_line)


'''
fourth interface
google and bing
'''
def sub_domain_gxfr(url_domain):
    popen = subprocess.Popen(['python', 'gxfr.py','--bxfr','--dns-lookup','-o','--domain','{name}'.format(name=url_domain)], stdout = subprocess.PIPE)
    while True:
        next_line = popen.stdout.readline()
        if next_line == '' and popen.poll() != None:
            break
        sys.stdout.write(next_line)


"""
make result outfile reqult.txt all_domain
"""
def make_domain():
    os.system("copy *.txt all_reqult.log && del *.txt")
    print("[+]del *txt\ncopy txt\n")
    list_domain = []
    f = open("all_reqult.log", "r")
    while True:
        line = f.readline()
        line = line.strip('').strip('\r').strip('"').strip(',').strip('               \r\r\n\",')
        if line:
            pass    # do something here
            line=line.strip()
            if '.' in line and '[S]' in line:
                list_domain.append(line.split('\t')[2])
            else:
                if '.' in line and '[R]' in line:
                    list_domain.append(line.split('\t')[3])
                else:
                    if '.' in line:
                        list_domain.append(line)
        else:
            break
    f.close()
    os.system("del all_reqult.log")
    list_domain = list(set(( list_domain )))
    with open('result.txt','w') as outfile:
        outfile.write('\n'.join(list_domain))
    fopen1 = open('report/result.txt','w')
    fopen1.write('\n'.join(list_domain))
    fopen1.close()

'''
first whois scan
'''
def sub_domain_whois(url_domain):
    a1=requests.get("http://whois.alexa.cn//whois.php?u=%s" %(url_domain))
    if 'Registration' not in a1.text:
        print 'whois error'
    else:
        print a1.text.replace("<br />", "")


"""
scan web module
"""
def scanweb():
    popen = subprocess.Popen(['python', 'BBScan.py', '-f', 'result.txt'], stdout = subprocess.PIPE)
    while True:
        next_line = popen.stdout.readline()
        if next_line == '' and popen.poll() != None:
            break
        sys.stdout.write(next_line)



"""
nmap port service vul scan
popen = subprocess.Popen(['nmap', '-p','1-65535','-vv','-Pn', '-T4','-iL','result.txt','-oX','report/nmap_port_services.xml'], stdout = subprocess.PIPE)

"""
def scan_nmap(url_domain):
    popen = subprocess.Popen(['nmap', '-vv','-Pn', '-T4','-iL','result.txt','-oX','report/nmap_port_services.xml'], stdout = subprocess.PIPE)
    while True:
        next_line = popen.stdout.readline()
        if next_line == '' and popen.poll() != None:
            break
        sys.stdout.write(next_line)





'''
report_browser.html open


'''


def report_all():
    left_html=Template(TEMPLATE_html)
    html_doc = left_html.substitute({'domain_result': 'result.txt', 'domain_port': 'nmap_port_services.xml', 'domain_wvs': '#','domain_webscan':'result_sentives.html'})
    with open('report/left.htm', 'w') as outFile:
        outFile.write(html_doc)









'''
main start
'''

def run(args):
    domain=args.domain
    if not domain:
        print '# Full automatic scanning tool for Pentesters\n# 1904521507[at]qq.com (http://github.com/rassec)'
        print('usage: f_a_s_t_scann.py -d cert.org.cn')
        sys.exit(1)
    try:

        print '''_________________________________________________________________________________________________
        _____           __              __          ______          __        __      __      _     _
        /    '          / |           /    )          /           /    )    /    )    / |     /|   /
    ---/__-------------/__|-----------\--------------/------------\--------/---------/__|----/-| -/--
      /               /   |            \            /              \      /         /   |   /  | /
    _/_______________/____|________(____/__________/___________(____/____(____/____/____|__/___|/____
              ------        ------          ------

                '''
        print '# Full automatic scan and Exp crack tool for Pentesters\n# only run windows\n# 1904521507[at]qq.com (http://github.com/rassec)'

        print "whois search..."
        #vpn_yes = raw_input("please open vpn!!!!!![y/n]")
        sub_domain_whois(domain)
        print "\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] first INTERFACE\nwaiting 5s ......\n\n"
        time.sleep(5)
        sub_domain_gxfr(domain)
        print "\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] second interface\nwaiting 5s ......\n\n"
        time.sleep(5)
        result=sub_doman_jiejie(domain)
        save_result('demo_geili.txt',result)
        print "\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] three interface\nwaiting 5s ......\n\n"
        time.sleep(5)
        sub_domain_wydomain(domain)
        print "\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] fourth interface\nwaiting 5s ......\n\n"
        time.sleep(5)
        #sub_domain_sublist(domain)
        print("\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] make domain result\nwaiting 5s ......\n\n")
        time.sleep(5)
        make_domain()
        #vpn_no = raw_input("please shutdown vpn!!!!!!")
        print("\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] scan web ...\nwaiting 5s ......\n\n")
        time.sleep(5)
        scanweb()
        print("\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] scan port ...\nwaiting 5s ......\n\n")
        time.sleep(5)
        #vpn_no = raw_input("please shutdown vpn!!!!!!")
        scan_nmap(domain)
        print("\n[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++] report result ...\nwaiting 5s ......\n\n")
        time.sleep(1)
        report_all()
        #webbrowser.open_new_tab(os.path.abspath('report/index.htm'))
        #os.system('"C:/Program Files/Internet Explorer/iexplore.exe"')
    except KeyboardInterrupt:
        sys.exit(1)




if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="f_a_s_t_scann.py v 2.0 to Full automatic scanning tool for Pentesters.")
    parser.add_argument("-d" , "--domain", metavar="",
        help="domain")
    args = parser.parse_args()
    try:
        run(args)
    except KeyboardInterrupt:
        sys.exit(1)